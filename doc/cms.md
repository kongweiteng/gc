#### CMS

##### What(是什么)

```text
CMS收集器是一种以获取最短回收停顿时间为目标的收集器。
CMS很适合比较关注服务响应速度，希望停顿使劲尽可能短的服务，以给用户带来良好的交互体验。
CMS是一款并发的、使用标记-清除算法的垃圾回收器，如果老年代使用CMS垃圾回收器，需要添加虚拟机参数-"XX:+UseConcMarkSweepGC"。
```

#### Why(为什么)

```text
CMS收集器是基于标记-清除算法实现的，它的回收过程相对前面几个回收器来说要复杂一些，整个过程分为四个步骤：
1）初始标记（CMS initial mark）
2）并发标记（CMS concurrent mark）
3）重新标记（CMS remark）
4）并发清除（CMS concurrent sweep）

初始标记和重新标记两个步骤仍然时候需要 stop the word，
初始标记：仅仅是标记一下GC Roots能直接关联到的对象，速度很快；
并发标记：阶段就是从GC Roots的直接关联对象开始遍历整个对象图的过程，这个过程耗时比较长，但是不会停顿用户线程；
重新标记：是为了修正并发标记期间，因用户线程继续运作儿导致标记产生变动的那一部分对象，这个阶段的停顿时间比并发标记的时间还要短；
并发清除：清理删除掉标记阶段判断已经死亡的对象，这个阶段是可以和用户线程同时并发工作的。


整个过程中，并发标记和并发清楚是耗时最长的阶段，垃圾收集线程和用户线程可以一起工作，总体来说，CMS收集内存的过程与用户线程是并发执行的。

CMS默认启动的回收线程数量是： (处理器核心数+3)/4

缺点：

1、由于是面向并发设计的回收器，CMS收集器对处理器资源非常的敏感，在并发阶段虽说不会导致用户线程终止，但是还是会占用一部分的线程资源，导致程序处理变慢；
当处理器核心数量不足四个时，CMS对用户程序的影响就可能变得很大。如果应用本来的处理器负载就很高，还要分出一半的运算能力去执行收集器线程，
就可能导致用户程序的执行速度忽然大幅降低。为了缓解这种情况，虚拟机提供了一种称为“增量式并发收集器”（Incremental Concurrent Mark Sweep/i-CMS）
的CMS收集器变种，是在并发标记、清理的时候让收集器线程、用户线程交替运行，尽量减少垃圾收集线程的独占资源的时间，
这样整个垃圾收集的过程会更长，但对用户程序的影响就会显得较少一些，直观感受是速度变慢的时间更多了，但速度下降幅度就没有那么明显。
实践证明增量式的CMS收集器效果很一般，从JDK 7开始，i-CMS模式已经被声明为“deprecated”，即已过时不再提倡用户使用，
到JDK 9发布后i-CMS模式被完全废弃。

2、CMS收集器无法处理“浮动垃圾”（Floating Garbage），有可能出现“Con-current Mode Failure”失败进而导致另一次完全“Stop The World”
的Full GC的产生。在CMS的并发标记和并发清理阶段，用户线程是还在继续运行的，程序在运行自然就还会伴随有新的垃圾对象不断产生，但这一部分垃圾对象是
出现在标记过程结束以后，CMS无法在当次收集中处理掉它们，只好留待下一次垃圾收集时再清理掉。这一部分垃圾就称为“浮动垃圾”。

3、同样也是由于在垃圾收集阶段用户线程还需要持续运行，那就还需要预留足够内存空间提供给用户线程使用，因此CMS收集器不能像其他收集器那样等待到老年代几乎完全被填满了再进行收集，
必须预留一部分空间供并发收集时的程序运作使用。在JDK 5的默认设置下，CMS收集器当老年代使用了68%的空间后就会被激活，这是一个偏保守的设置，
如果在实际应用中老年代增长并不是太快，可以适当调高参数-XX：CMSInitiatingOccu-pancyFraction的值


4、CMS是一款基于“标记-清除”算法实现的收集器，就可能想到这意味着收集结束时会有大量空间碎片产生。
空间碎片过多时，将会给大对象分配带来很大麻烦，往往会出现老年代还有很多剩余空间，
但就是无法找到足够大的连续空间来分配当前对象，而不得不提前触发一次Full GC的情况。为了解决这个问题，
CMS收集器提供了一个-XX：+UseCMS-CompactAtFullCollection开关参数（默认是开启的，此参数从JDK 9开始废弃），
用于在CMS收集器不得不进行Full GC时开启内存碎片的合并整理过程，由于这个内存整理必须移动存活对象，（在Shenandoah和ZGC出现前）是无法并发的。
这样空间碎片问题是解决了，但停顿时间又会变长。
因此虚拟机设计者们还提供了另外一个参数-XX：CMSFullGCsBefore-Compaction（此参数从JDK 9开始废弃），
这个参数的作用是要求CMS收集器在执行过若干次（数量由参数值决定）不整理空间的Full GC之后，下一次进入Full GC前会先进行碎片整理（默认值为0，
表示每次进入Full GC时都进行碎片整理）。
```
##### CMS收集器运行示意图
![ag3zSx.png](https://s1.ax1x.com/2020/08/06/ag3zSx.png)



### [GC介绍](../README.md)